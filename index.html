<html>
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene cursor="rayOrigin: mouse">
      <a-assets>
        <a-asset-item id="character" src="./assets/Character.glb"></a-asset-item>
        <a-asset-item id="floatingisland" src="./assets/floatingisland.glb"></a-asset-item>
        <a-asset-item id="mako" src="./assets/Mako.glb"></a-asset-item>
        <a-asset-item id="totoro" src="./assets/totoro.glb"></a-asset-item>
        <img id="skyTexture" src="./assets/starsmilky.jpg" />

        <audio id="totoro-audio" src="./assets/sound/totoro.mp3"></audio>
        <audio id="character-audio" src="./assets/sound/wow.mp3"></audio>
      </a-assets>
      <a-sky 
          src="#skyTexture"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 60000; easing: linear">
      </a-sky>

      <a-entity 
        id="back-button"
        geometry="primitive: plane; width: 1; height: 0.4"
        material="color: #222; opacity: 0.7"
        position="-10.797 -1.307 4.911"
        text="value: Back; align: center; color: #fff; width: 4"
        class="clickable"
        visible="false"
      ></a-entity>
      <a-entity 
        id="back-button2"
        geometry="primitive: plane; width: 1; height: 0.4"
        material="color: #222; opacity: 0.7"
        position="0.882 1.405 1.383"
        text="value: Back; align: center; color: #fff; width: 4"
        class="clickable"
        visible="false"
      ></a-entity>
      <a-entity
        id="floatingisland"
        position="0 0 0"
      >
        <a-gltf-model src="#floatingisland" scale="0.01 0.01 0.01"></a-gltf-model>
        <a-gltf-model id="totoro-model" src="#totoro" position="-0.442 1.351 0.811" scale="0.445 0.445 0.445" rotation="0 120.941 0"></a-gltf-model>
        <a-box 
        id="totoro-hitbox"
        position="-0.494 1.211 0.759"
        scale="0.350 0.394 0.277"
        width="2" height="3" depth="2"
        opacity="0" transparent="true"
        class="clickable"
      ></a-box>
        <a-gltf-model   
          id="character-model"
          src="#character" 
          position="-9.245 -1.624 4.529" 
          scale="0.209 0.209 0.209" 
          class="clickable"
        ></a-gltf-model>
        <a-box 
          id="character-hitbox"
          position="-9.245 -1.642 4.529"
          scale="0.706 0.583 0.211"
          width="2" height="3" depth="2"
          opacity="0" transparent="true"
          class="clickable"
        ></a-box>
      </a-entity>



      <a-entity 
      id="mainCamera"
      camera 
      position="-6.278 -0.829 15.253" 
      rotation="3.067 -8.702 -1.745"
      look-controls
      wasd-controls
      >
      <a-cursor></a-cursor>
      </a-entity>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var camera = document.querySelector('#mainCamera');
          var character = document.querySelector('#character-model');
          var hitbox = document.querySelector('#character-hitbox');
          var backBtn = document.querySelector('#back-button');
          var totoro = document.querySelector('#totoro-model');
          var totoroHitbox = document.querySelector('#totoro-hitbox');
          var backBtn2 = document.querySelector('#back-button2');
          var animationPlayed = false;
          var totoroFlying = false;

          var totoroAudio = document.querySelector('#totoro-audio');
          var characterAudio = document.querySelector('#character-audio');

          var initialPosition = {x: -6.278, y: -0.829, z: 15.253};
          var initialRotation = {x: 3.067, y: -8.702, z: -1.745};

          function stopTotoroAudio() {
            if (totoroAudio && !totoroAudio.paused) {
              totoroAudio.pause();
              totoroAudio.currentTime = 0;
            }
          }
          function stopCharacterAudio() {
            if (characterAudio && !characterAudio.paused) {
              characterAudio.pause();
              characterAudio.currentTime = 0;
            }
          }


          function moveCamera() {
            camera.setAttribute('position', {x: -9.271, y: -1.301, z: 5.824});
            camera.setAttribute('rotation', {x: -9.626, y: -12.605, z: 0});
            camera.setAttribute('wasd-controls', 'enabled', false);
            animationPlayed = false;
            character.removeAttribute('animation-mixer');
            backBtn.setAttribute('visible', true);
            backBtn2.setAttribute('visible', false);
            stopTotoroAudio();
          }
          function moveCameraTotoro() {
            camera.setAttribute('position', {x: -0.625, y: 1.293, z: 2.595});
            camera.setAttribute('rotation', {x: -0.888, y: -11.098, z: -2.198});
            camera.setAttribute('wasd-controls', 'enabled', false);
            totoroFlying = false;
            backBtn2.setAttribute('visible', true);
            backBtn.setAttribute('visible', false);
            stopCharacterAudio();
          }

          function playCharacterAnimation() {
            if (!animationPlayed) {
              character.setAttribute('animation-mixer', 'enabled: true; loop: once; timeScale: 1')
              animationPlayed = true;
            }
          }
          
          function handleCharacterClick() {
            if (Math.abs(camera.getAttribute('position').x - (-9.271)) > 0.01) {
              moveCamera();
            } else {
              playCharacterAnimation();
              if (characterAudio) {
                characterAudio.currentTime = 0;
                characterAudio.play();
              }
            }
          }

          function handleTotoroClick() {
            if (Math.abs(camera.getAttribute('position').x - (-0.625)) > 0.01) {
              moveCameraTotoro();
            } else if (!totoroFlying) {
              totoroFlying = true;
              if (totoroAudio) {
                totoroAudio.currentTime = 0;
                totoroAudio.play();
              }
              totoro.setAttribute('animation__fly', {
                property: 'position',
                to: '-0.442 2.5 0.811',
                dur: 600,
                easing: 'easeOutQuad',
                loop: false
              });
              totoro.setAttribute('animation__spin', {
                property: 'rotation',
                to: '0 480.941 0',
                dur: 1200,
                easing: 'linear',
                loop: false
              });
              setTimeout(function () {
                totoro.setAttribute('animation__flydown', {
                  property: 'position',
                  to: '-0.442 1.351 0.811',
                  dur: 600,
                  easing: 'easeInQuad',
                  loop: false
                });
              }, 600);
              setTimeout(function () {
                totoro.setAttribute('rotation', '0 120.941 0');
                totoroFlying = false;
              }, 1800);
            }
          }

          if (character) character.addEventListener('click', handleCharacterClick);
          if (hitbox) hitbox.addEventListener('click', handleCharacterClick);

          if (totoro) totoro.addEventListener('click', handleTotoroClick);
          if (totoroHitbox) totoroHitbox.addEventListener('click', handleTotoroClick);

          if (backBtn) {
            backBtn.addEventListener('click', function () {
              camera.setAttribute('position', initialPosition);
              camera.setAttribute('rotation', initialRotation);
              camera.setAttribute('wasd-controls', 'enabled', true);
              backBtn.setAttribute('visible', false);
              animationPlayed = false;
              character.removeAttribute('animation-mixer');
              stopTotoroAudio();
              stopCharacterAudio();
            });
          }

          if (backBtn2) {
            backBtn2.addEventListener('click', function () {
              camera.setAttribute('position', initialPosition);
              camera.setAttribute('rotation', initialRotation);
              camera.setAttribute('wasd-controls', 'enabled', true);
              backBtn2.setAttribute('visible', false);
              totoroFlying = false;
              stopTotoroAudio();
              stopCharacterAudio();
            });
          }

          character.removeAttribute('animation-mixer');
        });
      </script>
    </a-scene>
  </body>
</html>